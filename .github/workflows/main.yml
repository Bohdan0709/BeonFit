name: CI/CD Lab 6 (WinForms)

on:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build-windows-app:
    # 1. Використовуємо Windows, бо це Windows Forms
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Налаштовуємо середовище для збірки (MSBuild)
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      # 3. Налаштовуємо NuGet (для завантаження бібліотек, якщо є)
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.0
      
      - name: Restore NuGet packages
        run: nuget restore

      # 4.  (Саме тут створюється .exe)
      # Ця команда шукає ваш .sln або .csproj файл і будує його
      - name: Build Application
        run: msbuild /p:Configuration=Release /p:Platform="Any CPU"

      # 5. Вивід інформації (вимога завдання)
      - name: Show Author Info
        run: |
          echo "Build initiated by: ${{ github.actor }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"
        shell: bash

      # 6. Пакуємо готову програму в архів
      # Ми беремо все з папки bin/Release (там лежить скомпільований exe)
      - name: Archive Production Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BeonFit-Build
          path: '**/bin/Release/**'

      # 7. Створюємо zip-архів для релізу засобами PowerShell
      - name: Zip Release
        run: |
          # Шукаємо папку Release (де лежить exe) і архівуємо її
          Compress-Archive -Path .\*\bin\Release\* -DestinationPath BeonFit-Release.zip

      # 8. Публікація реліза
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: BeonFit App v1.0.${{ github.run_number }}
          body: |
            Автоматична збірка Windows Forms додатку.
            Автор: ${{ github.actor }}
            
            **Як запустити:**
            1. Скачайте архів.
            2. Розпакуйте.
            3. Запустіть файл **BeonFit.exe** (або з назвою вашого проекту).
          files: BeonFit-Release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
